<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ECG</title>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v3.js"></script>
    <style>
      body {
        background: radial-gradient(transparent, #c34d5c);
      }
      .container {
        margin: 0 auto;
        display: block;
        width: 1000px;
      }
      .ecg-bg {
        width: 1000px;
        height: 1000px;
        background-image: url(./ecg-front.png);
      }
      .ecg-screen {
        padding: 241px 187px;
        height: 458px;
      }

      g.x.axis {
        fill: rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="ecg-bg">
        <div class="ecg-screen"></div>
      </div>
    </div>

    <script>
      var t = -1,
        n = 300,
        data = [];

      var margin = {
          top: 6,
          right: 0,
          bottom: 40,
          left: 40,
        },
        width = n * 2 - margin.right,
        height = 450 - margin.top - margin.bottom;

      var x = d3.scale
        .linear()
        .domain([t - n + 1, t])
        .range([0, width]);

      var y = d3.time.scale().range([height, 0]).domain([0, 4000]);

      var line = d3.svg
        .line()
        .interpolate("basis")
        .x(function (d, i) {
          return x(d.time);
        })
        .y(function (d, i) {
          return y(d.value);
        });

      var svg = d3
        .select(".ecg-screen")
        .append("p")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .style("margin-left", -margin.left + "px")
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      svg
        .append("defs")
        .append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("width", width)
        .attr("height", height);

      var xAxis = d3.svg.axis().scale(x).orient("bottom");
      var axis = svg
        .append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call((x.axis = xAxis));

      var path = svg
        .append("g")
        .attr("clip-path", "url(#clip)")
        .append("path")
        .style("fill", "none")
        .style("stroke", "black")
        .style("stroke-width", "1")
        .data([data])
        .attr("class", "line");

      function tick() {
        // update the domains
        x.domain([t - n + 2, t]);

        // redraw the line
        svg.select(".line").attr("d", line).attr("transform", null);

        // slide the x-axis left
        axis.call(x.axis);

        // slide the line left
        path.attr("transform", "translate(" + x(t - n) + ")");

        // pop the old data point off the front
        if (data.length > n) data.shift();
      }

      if ("WebSocket" in window) {
        var ws = new WebSocket("ws://192.168.0.37/ws");
        ws.onerror = (e) => {
          console.log({ e });
        };
        ws.onopen = function () {
          ws.send("Hello");
        };

        ws.onmessage = function (evt) {
          const val = evt.data;
          data.push({
            time: ++t,
            value: parseInt(val),
          });
          tick();
        };

        ws.onclose = function () {
          alert("Connection is closed...");
        };
      } else {
        alert("WebSocket NOT supported by your Browser!");
      }
    </script>
  </body>
</html>
